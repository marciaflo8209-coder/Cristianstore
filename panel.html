<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cristian Store - Panel</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="firebase.js"></script>
</head>
<body class="panel-body">

  <header class="header">
    <h1 class="panel-title">Cristian Shop</h1>
    <button id="logoutBtn">Cerrar sesión</button>
  </header>

  <div class="welcome">
    <h2 id="welcomeText"></h2>
    <p>Saldo: $<span id="saldo"></span></p>
  </div>

  <section id="productos" class="productos"></section>

  <div id="adminPanel" class="admin-access" style="display:none;">
    <button id="adminBtn">Panel de administración</button>
  </div>

  <script type="module">
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";
    import { app } from "./firebase.js";

    const db = getDatabase(app);
    const usuario = localStorage.getItem("usuario");
    const rol = localStorage.getItem("rol");

    if (!usuario) {
      window.location.href = "index.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    const welcomeText = document.getElementById("welcomeText");
    const saldoElem = document.getElementById("saldo");
    const productosContainer = document.getElementById("productos");
    const adminPanel = document.getElementById("adminPanel");

    async function cargarUsuario() {
      const userRef = ref(db, "usuarios/" + usuario);
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        welcomeText.textContent = `Bienvenido, ${usuario}`;
        saldoElem.textContent = data.saldo.toFixed(2);

        if (usuario === "Cristianstore") {
          adminPanel.style.display = "block";
        }

        cargarProductos(data.saldo);
      }
    }

    async function cargarProductos(saldoActual) {
      const productosRef = ref(db, "productos");
      const snapshot = await get(productosRef);

      productosContainer.innerHTML = "";

      if (snapshot.exists()) {
        const productos = snapshot.val();
        Object.keys(productos).forEach((key) => {
          const p = productos[key];
          const productoDiv = document.createElement("div");
          productoDiv.classList.add("producto");

          productoDiv.innerHTML = `
            <img src="${p.imagen}" alt="${p.nombre}">
            <h3>${p.nombre}</h3>
            <p>${p.descripcion}</p>
            <p class="precio">$${p.precio.toFixed(2)}</p>
            <p>Stock: ${p.stock}</p>
            <button ${saldoActual < p.precio ? 'disabled' : ''}>${saldoActual < p.precio ? 'Saldo insuficiente' : 'Comprar'}</button>
          `;

          const boton = productoDiv.querySelector("button");
          boton.addEventListener("click", async () => {
            if (saldoActual >= p.precio) {
              const nuevoSaldo = saldoActual - p.precio;
              await update(ref(db, "usuarios/" + usuario), { saldo: nuevoSaldo });
              await update(ref(db, "productos/" + key), { stock: p.stock - 1 });
              alert(`✅ Compra exitosa!\nProducto: ${p.nombre}\nLicencia: ${p.licencia}`);
              location.reload();
            } else {
              alert("Saldo insuficiente ❌");
            }
          });

          productosContainer.appendChild(productoDiv);
        });
      } else {
        productosContainer.innerHTML = "<p>No hay productos disponibles.</p>";
      }
    }

    document.getElementById("adminBtn").addEventListener("click", () => {
      window.location.href = "admin.html";
    });

    cargarUsuario();
  </script>
</body>
</html>
